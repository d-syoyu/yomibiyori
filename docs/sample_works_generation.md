# サンプル作品生成ジョブ

## 概要

`generate_sample_works.yml` は、AIを使用して5つのリアルなユーザーアカウントで下の句を自動生成・投稿するGitHub Actionsワークフローです。

ユーザーがまだ少ない初期段階でも、他のユーザーの作品を鑑賞できる環境を作り、投稿のハードルを下げることを目的としています。

## スケジュール

- **実行時刻**: 毎日 07:00 JST (`0 22 * * *` UTC)
- **タイミング**: お題配信（06:00 JST）の1時間後
- **手動実行**: `workflow_dispatch` で任意のタイミングで実行可能

## サンプルアカウント

**50個の個性的なアカウント**がAIによって運用されます。日替わりでランダムに5人を選択して投稿します。

### アカウント分類

アカウントは5つの派閥に分類され、カテゴリーとの相性を考慮して選択されます:

#### 繊細・情景派 (10人)
月夜のゆき、雨音しおり、夕暮れのゆあ、水面みずき、空色のそら、椿のつぼみ、楓の葉音、陽だまりひなた、星月ルナ、雪解けゆき

#### 明るい・ポジティブ派 (10人)
晴れときどき詩、朝日あおい、夏空なつき、春風はる、笑顔のめい、光彩ひかり、咲くさき、灯りあかり、花咲くはな、にこにこ

#### ユーモア・遊び心派 (10人)
笑う葵、脱線太郎、もちもち桃、ぽちっと、くまさん参上、猫かぶり、ぴこぴこ、ごろごろ、ぷるぷる、ふわふわ雲

#### 恋愛・感情派 (10人)
花びら舞う、恋する藍、想いのみう、結ぶゆい、凛とした恋、恋ごころ、姫桜、舞うまい、湖畔の恋、夢見るゆめ

#### 哲学・深遠派 (10人)
静寂のれん、禅の境地、深淵のしん、無の境地、幻想げん、問う人、静謐のせい、影法師、闇と光、時を紡ぐ

### 日替わり選択の仕組み

- 毎日、日付をシード値としてランダムに5人を選択
- 同じ日は同じアカウントが選ばれる（再現性あり）
- 全50人が均等に活躍する機会を持つ

## 動作フロー

1. **アカウント認証**
   - 各サンプルアカウントでサインアップまたはログインを試行
   - アクセストークンを取得

2. **テーマ取得**
   - 4つのカテゴリー（恋愛、季節、日常、ユーモア）ごとに今日のお題を取得
   - APIエンドポイント: `GET /api/v1/themes/today?category={category}`

3. **下の句生成**
   - 上の句（5-7-5）を受け取り、AIが下の句（7-7）を生成
   - AI Provider: `THEME_AI_PROVIDER` で設定（xai / claude / openai）
   - 音数（モーラ数）検証: 7-7 パターンを厳密にチェック
   - リトライ: 最大3回まで生成を試行

4. **作品投稿**
   - 生成した下の句を投稿
   - APIエンドポイント: `POST /api/v1/works`
   - レート制限対策: 各投稿の間に1秒のディレイ

5. **統計レポート**
   - 成功・失敗件数を集計
   - ジョブ完了時にサマリーを出力

## 設定パラメータ

### 環境変数（GitHub Actions Secrets）

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `DATABASE_URL` | PostgreSQL接続URL（インポート用） | ✓ |
| `THEME_AI_PROVIDER` | AI Provider (xai / claude / openai) | ✓ |
| `XAI_API_KEY` | X.ai Grok APIキー（provider=xaiの場合） | △ |
| `ANTHROPIC_API_KEY` | Anthropic Claude APIキー（provider=claudeの場合） | △ |
| `OPENAI_API_KEY` | OpenAI APIキー（provider=openaiの場合） | △ |
| `SUPABASE_PROJECT_REF` | Supabaseプロジェクト参照 | ✓ |
| `SUPABASE_URL` | Supabase URL | ✓ |

### ワークフロー入力（手動実行時）

| パラメータ | 説明 | デフォルト値 |
|-----------|------|-------------|
| `accounts` | 使用するアカウント数（1-5） | 5 |
| `per_category` | カテゴリーあたりの投稿数 | 2 |

## スクリプト実行例

### ローカル実行（開発環境）

```bash
# 環境変数を設定
export DATABASE_URL="postgresql://..."
export THEME_AI_PROVIDER="xai"
export XAI_API_KEY="xai-..."
export SUPABASE_PROJECT_REF="your-project-ref"
export API_BASE_URL="https://yomibiyori-production.up.railway.app/api/v1"

# スクリプト実行
python scripts/generate_sample_works.py --accounts 5 --per-category 2
```

### Dry Run（投稿をスキップ）

```bash
python scripts/generate_sample_works.py --dry-run
```

### カスタム設定で実行

```bash
# 3つのアカウントで、各カテゴリーに1作品ずつ投稿
python scripts/generate_sample_works.py --accounts 3 --per-category 1
```

## AI生成の仕組み

### AIプロバイダー

- **デフォルト**: XAI Grok (grok-4-fast-reasoning)
- お題生成スクリプトと同じプロバイダーを使用し、一貫性を保つ
- 環境変数 `THEME_AI_PROVIDER` で変更可能 (xai / claude / openai)

### カテゴリーとアカウント派閥の相性

各カテゴリーに対して、派閥の相性に基づいて優先的に選択:

| カテゴリー | 優先順位（派閥: 高→低） |
|-----------|------------------|
| 恋愛 | 恋愛・感情派 → 繊細・情景派 → 哲学・深遠派 → 明るい・ポジティブ派 → ユーモア・遊び心派 |
| 季節 | 繊細・情景派 → 明るい・ポジティブ派 → 恋愛・感情派 → 哲学・深遠派 → ユーモア・遊び心派 |
| 日常 | 明るい・ポジティブ派 → ユーモア・遊び心派 → 哲学・深遠派 → 繊細・情景派 → 恋愛・感情派 |
| ユーモア | ユーモア・遊び心派 → 明るい・ポジティブ派 → 恋愛・感情派 → 繊細・情景派 → 哲学・深遠派 |

**選択ロジック**:
1. 日替わりで5人をランダム選択
2. 選ばれた5人の中から、カテゴリーに合った派閥順にソート
3. 上位2人（`--per-category 2`の場合）がそのカテゴリーに投稿

### ペルソナ反映プロンプト

AIクライアント（[app/services/work_ai_client.py](../app/services/work_ai_client.py)）は各アカウントの詳細なペルソナをプロンプトに反映します。

**プロンプト例（月夜のゆき）**:
```
あなたは音数（モーラ数）に精通した現代的な詩人「月夜のゆき」です。
ペルソナ: 静かで繊細な情景描写を心がけ、夜や月の美しさを感じさせる表現を使います。

上の句（5-7-5）を受け取り、下の句（7-7）で完結させます。
必ず7-7の音数を守り、一音一音数えながら作句します。
あなたの個性とペルソナを活かした表現で詠んでください。

【カテゴリー】
季節

【あなたのペルソナ】
静かで繊細な情景描写を心がけ、夜や月の美しさを感じさせる表現を使います。
```

**他のアカウント例**:
- **笑う葵**: ユーモアがあり、くすっと笑える視点や、少し意外性のある表現を好みます。
- **花びら舞う**: 恋愛や季節の移り変わりに敏感で、感情豊かで華やかな表現を使います。
- **脱線太郎**: 予想外の展開や脱線した視点で、面白おかしく詠みます。
- **夢見るゆめ**: 恋の夢や理想を優しく儚く表現します。
- **禅の境地**: 禅的な静けさと悟りの瞬間を表現します。

全50アカウントそれぞれに固有のペルソナが設定されており、AIがそれに基づいて個性的な下の句を生成します。

### 音数検証

- `count_syllables()`: pykakasiでひらがな変換し、モーラ数をカウント
- `validate_77()`: 生成結果が正確に7-7のパターンであることを確認
- リトライロジック: 不合格の場合、最大3回まで再生成

### サンプル生成例

**上の句（恋愛カテゴリー）**:
```
すれ違う
いつもの駅で
また会えた
```

**AI生成下の句**:
```
時が止まれば
いいのにと願う夜
```

**完成作品（5-7-5-7-7）**:
```
すれ違う
いつもの駅で
また会えた
時が止まれば
いいのにと願う夜
```

## トラブルシューティング

### 認証エラー

**症状**: `✗ 認証失敗: {username}`

**原因**:
- Supabase Authのメール確認が有効になっている
- アカウントが既に削除されている

**対策**:
- Supabaseダッシュボードで該当ユーザーを確認
- メール確認を無効化（テストアカウント用）
- 既存アカウントが削除されていれば再作成

### テーマ取得エラー

**症状**: `✗ テーマ取得失敗: {category}`

**原因**:
- 指定カテゴリーの今日のお題が存在しない
- お題生成ジョブが失敗している

**対策**:
- `generate_themes.yml` ワークフローを手動実行
- DBで `themes` テーブルを確認: `SELECT * FROM themes WHERE date = CURRENT_DATE`

### AI生成エラー

**症状**: `✗ AI生成失敗: {error}`

**原因**:
- APIキーが無効または期限切れ
- レート制限に達している
- タイムアウト

**対策**:
- APIキーを確認・更新
- `XAI_TIMEOUT` / `CLAUDE_TIMEOUT` / `OPENAI_TIMEOUT` を増加
- プロバイダーを変更（`THEME_AI_PROVIDER`）

### 投稿エラー

**症状**: `✗ 投稿失敗: {error}`

**原因**:
- 投稿時間外（22:00–翌06:00 JST）
- 同一カテゴリーに既に投稿済み
- 40文字制限超過

**対策**:
- ジョブ実行時刻を調整（06:00–22:00 JSTの範囲内）
- テスト環境では時間制限を無効化
- 生成された下の句の文字数を確認

## セキュリティ考慮事項

### アカウント管理

- サンプルアカウントのパスワードは `Sample123!Secure` で統一
- 本番環境では環境変数化を検討
- 定期的なパスワードローテーション

### API制限

- レート制限対策として各投稿間に1秒のディレイ
- Expo Push通知は送信しない（サンプルアカウント用）
- 本番APIエンドポイントを使用するため、過度な実行は避ける

## 今後の改善案

1. **バリエーション増加**
   - Few-shot examplesの追加
   - Temperature調整によるクリエイティビティ向上

2. **エラーハンドリング**
   - Sentryへのエラー送信
   - Slack通知による監視

3. **パフォーマンス最適化**
   - 並列実行による高速化
   - キャッシュによるAPI呼び出し削減

## 関連ドキュメント

- [theme_generation_job.md](./theme_generation_job.md) - お題生成ジョブ
- [ranking_finalization_job.md](./ranking_finalization_job.md) - ランキング確定ジョブ
- [actions_secrets_checklist.md](./actions_secrets_checklist.md) - GitHub Actions環境変数一覧
- [REQUIREMENTS.md](../REQUIREMENTS.md) - 機能要件
