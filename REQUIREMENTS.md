# REQUIREMENTS.md - 詠日和 プロジェクト仕様

## プロジェクト概要
詠日和（よみびより）は、AI が提案する「上の句」とユーザーが詠む「下の句」を組み合わせ、感性豊かな句を共有するポエティック SNS です。
毎日 06:00 に 4 つのカテゴリー（恋愛、季節、日常、ユーモア）ごとにお題が配信され、ユーザーは各カテゴリーにつき 22:00 までに 1 首ずつ投稿できます。22:00 時点でカテゴリーごとにランキングを確定します。

---

## 機能要件（Functional Requirements）

### 1. 認証・アカウント管理
- **要件ID**: FR-001
- **概要**: Supabase Auth を利用し、メール＋OAuth（Google / Apple）でログイン可能にする。
- **詳細**:
  - JWT ベース認証。`authenticated` ロールは一般ユーザー、`service_role` は管理用。
  - ユーザーごとに 1 カテゴリーあたり 1 日 1 首まで投稿可能（全カテゴリー合計で最大 4 首/日）。
  - ローカル DB の `users` テーブルに Supabase `auth.users` の `id` / `email` / `user_metadata.display_name` を同期する。
  - 認証が無いユーザーは投稿系 API を利用できない。

### 2. お題（上の句）生成と配信
- **要件ID**: FR-002
- **概要**: 毎日 21:00 に AI が各カテゴリーの上の句を生成し、カテゴリに紐づけて保存する。
- **詳細**:
  - ジョブは GitHub Actions Scheduler (cron: `0 12 * * *` UTC = 21:00 JST) で実行。
  - 4 つのカテゴリー（恋愛、季節、日常、ユーモア）ごとに上の句（5-7-5）を生成。
  - AI プロバイダー: OpenAI (gpt-4o)、Anthropic (Claude Sonnet 4.5)、または X.ai (Grok) を環境変数で選択可能。
  - 生成された句は pykakasi で音数検証され、5-7-5 形式に適合するまで最大 3 回リトライ。
  - 生成結果は PostgreSQL の `themes` テーブルに `(date, category, text)` として保存。
  - 06:00 に Expo Push などでユーザーへ配信（未実装）。

### 3. 下の句投稿
- **要件ID**: FR-003
- **概要**: ユーザーは各カテゴリーのお題（テーマ）に対して、1 カテゴリーあたり 1 日 1 首、40 文字以内で投稿できる。
- **詳細**:
  - 投稿時に `theme_id` を必須パラメータとして指定し、どのカテゴリーのお題に対する投稿かを明示する。
  - 投稿可能時間帯: 06:00–22:00 JST（この時間外は投稿不可）。
  - 同一カテゴリーへの重複投稿を防止：同じユーザーが同じカテゴリーに同日内に 2 首以上投稿できない。
  - 異なるカテゴリーであれば同日内に複数投稿可能（最大 4 首/日）。
  - 投稿内容は即時保存し、直後に鑑賞画面へ遷移。
  - 投稿済み作品はマイページおよびカテゴリー別一覧で参照可能。
  - RLS で自身の作品のみ編集／削除可能にする（未実装）。

### 4. 感謝（いいね）・感想リアクション
- **要件ID**: FR-004  
- **概要**: 作品に対して「感謝（いいね）」と「感想（インプレッション）」を記録する。  
- **詳細**:
  - Redis ZSET を利用し、リアルタイムでスコアを更新。  
  - ユーザー ID を直接キーに含めず、ハッシュ化すること。  
  - インプレッションはビューアのハッシュ＋回数を記録し、重み付けに利用。

### 5. ランキング算出（公平性改善版）
- **要件ID**: FR-005
- **概要**: 時間帯による不公平を排除するため、ベイズ平均とWilsonスコアを組み合わせた多段階アルゴリズムを使用。
- **詳細**:
  - **第1段階：有効サンプルサイズ算出**
    - ユニークビューア数を主要指標とする
    - インプレッション数はユニークビューア数×5に制限（操作防止）
    - 有効サンプルサイズ = max(ユニークビューア数, capped_impressions ÷ 2)
  - **第2段階：スコアリング方法の選択**
    - 有効サンプル < 100: **ベイズ平均**を適用
      - 事前分布: 全体平均いいね率5%、信頼度100
      - 式: (100 × 0.05 + サンプル数 × 観測率) ÷ (100 + サンプル数)
      - 効果: 少ないサンプルでも全体平均で補完し、極端なスコアを防ぐ
    - 有効サンプル ≥ 100: **Wilson下限信頼区間**（95%）を使用
      - 十分なサンプル数があれば統計的信頼性を重視
  - **第3段階：時間正規化**
    - 投稿時刻から22:00までの露出時間を計算
    - 露出時間が短い作品（遅い時間帯投稿）ほどスコアを補正
    - 正規化係数 = min(2.0, 最大露出時間16h ÷ 実際の露出時間)
    - 最終スコア = 基礎スコア × 正規化係数
  - **第4段階：異常値検出とペナルティ**
    - インプレッション/ユニークビューア比率 > 10:1 の場合
    - ペナルティ係数 = max(0.1, 1.0 - ((ratio - 10) ÷ 10) × 0.2)
    - 不正な大量インプレッション送信を抑制
  - **データ永続化**:
    - Redis ZSETにリアルタイムスコアを保持
    - 22:00にPostgreSQLへスナップショット保存
    - API は最新の Redis キャッシュを優先し、無い場合はスナップショットを返す

### 6. ランキング確定処理
- **要件ID**: FR-006  
- **概要**: 毎日 22:00 に当日のランキングを確定し、DB に保存する。  
- **詳細**:
  - Cron ジョブが Redis のランキング値を取得し、`rankings` テーブルへ書き込む。  
  - ユーザー通知は 22:00 に配信。  
  - この時間帯は投稿・いいねを停止し、翌 06:00 まで閲覧のみ許可。

### 7. スポンサータイアップ
- **要件ID**: FR-007  
- **概要**: スポンサーが上の句とカテゴリを指定してタイアップを行える。  
- **詳細**:
  - 管理画面からスポンサー情報を登録。  
  - 作品一覧に「提供：スポンサー名」を表記。  
  - ターゲット地域／年齢帯に応じたフィルタリングを考慮。

### 8. 通知配信
- **要件ID**: FR-008  
- **概要**: Expo Push 等でユーザーへ各フェーズの通知を送る。  
- **詳細**:
  - 06:00: お題配信通知。  
  - 21:50: 投稿締切リマインダ。  
  - 22:00: ランキング確定通知。

### 9. モバイルアプリ UI
- **要件ID**: FR-009
- **概要**: React Native + Expo でモバイルアプリを提供。
- **画面構成**:
  1. **LoginScreen** – Supabase Auth による OAuth ログイン／新規登録（email + display_name 必須）。
  2. **CategorySelectionScreen** – 4 つのカテゴリー（恋愛、季節、日常、ユーモア）を選択。
  3. **ActionSelectionScreen** – 選択したカテゴリーで「詠む」または「鑑賞する」を選択。
  4. **CompositionScreen** – 選択したカテゴリーのお題（上の句）を表示し、下の句を投稿。
  5. **AppreciationScreen** – カテゴリー別または全カテゴリーの作品一覧を表示。いいね機能付き。
  6. **RankingScreen** – カテゴリー別のリアルタイムランキング表示（未実装）。
  7. **MyPoemsScreen** – 自身の投稿作品一覧と履歴。

---

## UI 仕様（UI Specification）

### 1. 画面フロー
1. **LoginScreen**
   - Supabase Auth によるメール＋パスワード認証。
   - 新規登録時は email と display_name が必須。
   - OAuth（Google / Apple）は未実装。

2. **CategorySelectionScreen**
   - 4 つのカテゴリー（恋愛 💕、季節 🌸、日常 ☕、ユーモア 😄）をカード形式で表示。
   - カテゴリーをタップすると ActionSelectionScreen へ遷移。

3. **ActionSelectionScreen**
   - 選択したカテゴリーで「詠む」または「鑑賞する」を選択。
   - 「詠む」: CompositionScreen へ遷移。
   - 「鑑賞する」: AppreciationScreen へ遷移。

4. **CompositionScreen**
   - 選択したカテゴリーの上の句（5-7-5）を固定表示。
   - 下の句（7-7）を 100 文字以内で入力（実際のバリデーションは 40 文字以内）。
   - 文字数カウンタ表示。
   - 投稿後は AppreciationScreen へ遷移し、成功ダイアログを表示。

5. **AppreciationScreen**
   - 「すべて」タブ: 全カテゴリーの作品を新しい順に表示（最大 200 件）。
   - カテゴリータブ: 選択したカテゴリーの作品のみ表示（最大 50 件）。
   - 各作品にいいねボタン（♥）と現在のいいね数を表示。
   - プルダウンでリフレッシュ可能。

6. **RankingScreen**
   - カテゴリー別のリアルタイムランキング表示（未実装）。

7. **MyPoemsScreen**
   - 自身が投稿した作品の一覧を新しい順に表示。
   - 各作品のカテゴリー、本文、投稿日時を表示。

### 2. フェーズステータス
| フェーズ | 時間帯 | 機能状態 |
| -------- | ------ | -------- |
| 通常 | 06:00–21:49 | 投稿／いいね／閲覧が可能 |
| 締切間際 | 21:50–21:59 | 締切アラートを常時表示 |
| 閉鎖 | 22:00–翌06:00 | 投稿・いいね停止、閲覧のみ |

---

## 非機能要件（Non-Functional Requirements）

### パフォーマンス
- 投稿・いいね API は 100ms 以内を目標。  
- Redis キャッシュでランキング応答を安定化。  
- ワーカージョブは 5 分以内に完了すること。

### セキュリティ
- 全テーブルで Row Level Security (RLS) を有効化。  
- JWT の署名・有効期限を検証し、HTTPS 通信のみ許可。  
- API キーやシークレットは `.env` に定義し、リポジトリへ含めない。

### 可用性
- 目標稼働率 99%。  
- Cron ジョブは冗長化（Workers + Railway バックアップ）。  
- 障害時はフェイルオーバーで Redis → PostgreSQL スナップショットへ切替。

### スケーラビリティ
- Redis と PostgreSQL はマネージドサービスを想定し、水平スケール可能にする。  
- API はステートレスに設計し、複数インスタンス配備を前提とする。

### コーディング規約
- Python は PEP8 + Black、Type Hints を必須。  
- TypeScript / React Native は ESLint + Prettier を適用。  
- FastAPI では OpenAPI ドキュメント（`/docs`）を正確に維持。  
- 例外は Sentry に、操作ログは PostHog に送信。

### ログ・監視
- Sentry でエラー監視、PostHog で行動分析。  
- API とジョブは JSON 形式で構造化ログを出力。  
- 重大障害時は Slack Webhook で通知。

### テスト
- Pytest でユニット／統合テストを実装。  
- FastAPI TestClient を用いた API テスト。  
- CI（GitHub Actions）でテスト・型チェックを実行。

---

## 開発ガイドライン

- Supabase Auth で新規ユーザーを作成・更新する際は Functions もしくは Cron ジョブで `users` テーブルと同期する。  
- DB スキーマ変更は Alembic マイグレーションで管理し、PR レビューを経て適用。  
- コード生成 API（AI 上の句生成）は安全なサンドボックスで実行し、本番キーは使用しない。  
- `.env` に機密情報を置き、`env.example` で必要なキーを明示する。

---

## データモデル概要

| エンティティ | 主なフィールド | 説明 |
| ------------ | -------------- | ---- |
| users | id (UUID), name, email, created_at | Supabase Auth と同期されたユーザー情報 |
| themes | id (UUID), text, category, date, sponsored, created_at | カテゴリー別の日替わりお題（上の句 5-7-5）|
| works | id (UUID), user_id, theme_id, text, created_at, updated_at | ユーザー投稿の下の句（40 文字以内）|
| likes | id (UUID), user_id, work_id, created_at | 感謝（いいね）アクション（1 ユーザー 1 作品 1 回） |
| rankings | id (UUID), theme_id, work_id, score, snapshot_time | 22:00 時点の確定ランキング（未実装） |
| sponsors | - | スポンサー情報（未実装） |

**注:** 1 ユーザーは 1 カテゴリーにつき 1 日 1 首まで投稿可能。`works` テーブルには `(user_id, theme_id)` に対する一意性制約は無いが、`works.create_work` サービスでカテゴリーごとの重複投稿を防止。

---

## スケジュール（ワークフロー）

| 時刻 | 処理 | 実行環境 |
| ---- | ---- | -------- |
| 21:00（前日） | AI による上の句生成 | GitHub Actions Scheduler / Railway |
| 06:00 | お題配信通知・投稿受付開始 | Expo Push / FastAPI |
| 06:00–21:59 | 投稿・感謝・ランキング更新 | FastAPI + Redis |
| 21:50 | 締切リマインダ通知 | Expo Push |
| 22:00 | ランキング確定・通知 | Cron ジョブ |
| 22:00–翌06:00 | 閲覧のみ可能 | FastAPI |

---

## 外部サービス連携

| 分類 | サービス | 用途 |
| ---- | -------- | ---- |
| 認証 | Supabase Auth | JWT 認証・ユーザー管理 |
| DB | PostgreSQL（Neon / Supabase） | 永続データ |
| キャッシュ | Upstash Redis | ランキング・リアルタイム指標 |
| ストレージ | Cloudflare R2 | 画像・スナップショット |
| ジョブ | GitHub Actions Scheduler / Railway | お題生成・定期処理 |
| Push 通知 | Expo Push API | モバイル通知 |
| 監視 | Sentry / PostHog | 障害監視・利用分析 |

---

## MVP 指標（KPI）
- 新規投稿ユーザー率：50%以上  
- 1 日の平均投稿数：3,000 件  
- 平均滞在時間：3 分以上  
- スポンサータイアップ消化率：10%以上

---

## クリエイティブ方針
- 「詠み手と AI が共創する場」として、詩情と静謐さを大切にする。  
- UI は余白を活かし、縦書き表示にも対応。  
- コミュニティの健全性を保つため、モデレーションガイドラインを整備。  
- オフラインイベントや投稿キャンペーンに発展させる余地を残す。

---

この仕様書は Codex エージェントおよび開発チームが参照し、要件の整合性と開発の指針として活用します。
